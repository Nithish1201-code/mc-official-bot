# Deployment Guide

Complete guide for deploying MC Bot infrastructure to production.

## System Requirements

- Ubuntu 20.04 LTS or newer (Debian 11+)
- 2GB RAM minimum
- 2 CPU cores minimum
- 5GB disk space
- Public or private IP with open ports
- Sudo access for system service installation

## Remote VPS Deployment

### 1. Initial Server Setup

```bash
# SSH into your VPS
ssh root@your-vps-ip

# Update system
apt-get update && apt-get upgrade -y

# Clone repository
git clone https://github.com/Nithish1201-code/mc-official-bot.git
cd mc-official-bot

# Run setup (will detect and install everything)
bash setup.sh
```

### 2. Configure Discord Bot

Get credentials from [Discord Developer Portal](https://discord.com/developers/applications):

1. Create New Application
2. Go to "Bot" section and create bot
3. Copy token to `bot/.env`:

```bash
nano bot/.env
```

```env
DISCORD_BOT_TOKEN=<paste-token-here>
DISCORD_APPLICATION_ID=<paste-app-id-here>
DISCORD_PUBLIC_KEY=<paste-public-key-here>
```

Save and exit (Ctrl+O, Enter, Ctrl+X).

### 3. Start Services

```bash
# Start backend
sudo systemctl start mc-backend.service
sudo systemctl start mc-bot.service

# Enable auto-start on boot
sudo systemctl enable mc-backend.service mc-bot.service

# Check status
systemctl status mc-backend.service
systemctl status mc-bot.service
```

### 4. Monitor Logs

```bash
# Backend logs
journalctl -u mc-backend.service -f

# Bot logs (new terminal)
journalctl -u mc-bot.service -f

# All MC services
journalctl -u "mc-*" -f
```

## Docker Deployment

### Using Docker Compose

```bash
# Create .env file
cp .env.example .env

# Edit configuration
nano .env

# Start containers
docker-compose up -d

# Check logs
docker-compose logs -f

# Stop services
docker-compose down
```

### Standalone Docker

```bash
# Build images
docker build -f Dockerfile.backend -t mc-backend:latest .
docker build -f Dockerfile.bot -t mc-bot:latest .

# Run backend
docker run -d \
  --name mc-backend \
  -p 3000:3000 \
  -e API_KEY=<key> \
  -e MINECRAFT_PATH=/minecraft \
  -v /path/to/minecraft:/minecraft \
  mc-backend:latest

# Run bot
docker run -d \
  --name mc-bot \
  -e DISCORD_BOT_TOKEN=<token> \
  -e DISCORD_APPLICATION_ID=<id> \
  -e BACKEND_URL=http://mc-backend:3000 \
  --link mc-backend \
  mc-bot:latest
```

## Configuration Files

### `config.json` (Root)

Generated by setup.sh. Contains:
- API keys
- Paths to Minecraft/Crafty
- Logging configuration

### `backend/.env`

- `API_KEY` - Secret key for authorization
- `PORT` - Backend port (default: 3000)
- `MINECRAFT_PATH` - Path to server directory
- `CRAFTY_PATH` - Path to Crafty installation

### `bot/.env`

- `DISCORD_BOT_TOKEN` - Bot token from Discord
- `DISCORD_APPLICATION_ID` - Application ID
- `BACKEND_URL` - Backend API URL
- `BACKEND_API_KEY` - Must match backend API_KEY

## Network Configuration

### Firewall Rules (UFW)

```bash
# Allow SSH
sudo ufw allow 22/tcp

# Allow backend API
sudo ufw allow 3000/tcp

# Enable firewall
sudo ufw enable
```

### Nginx Reverse Proxy (Optional)

```nginx
server {
    listen 80;
    server_name api.example.com;

    location / {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

Enable with:
```bash
sudo systemctl enable nginx
sudo systemctl start nginx
```

## Maintenance

### Check System Health

```bash
# Service status
systemctl status mc-*

# Resource usage
top -u $(whoami)

# Disk space
df -h

# Logs for errors
journalctl -u mc-backend.service --no-pager | grep ERROR
```

### Update Code

```bash
cd /opt/mc-bot

# Pull latest
git pull origin main

# Rebuild
npm install
npm run build

# Restart services
sudo systemctl restart mc-backend.service mc-bot.service

# Verify
systemctl status mc-*
```

### Backup Configuration

```bash
# Backup config
sudo cp config.json config.json.backup
sudo cp backend/.env backend/.env.backup
sudo cp bot/.env bot/.env.backup

# On another machine:
scp user@vps:/opt/mc-bot/config.json ./backup/
scp user@vps:/opt/mc-bot/backend/.env ./backup/
scp user@vps:/opt/mc-bot/bot/.env ./backup/
```

## Troubleshooting

### Backend not starting

```bash
# Check logs
journalctl -u mc-backend.service -n 50

# Verify API key is set
grep API_KEY backend/.env

# Test manually
cd backend && npm run build && node dist/index.js
```

### Bot not connecting

```bash
# Verify Discord token
grep DISCORD_BOT_TOKEN bot/.env

# Check backend connectivity
curl http://localhost:3000/health

# View bot logs
journalctl -u mc-bot.service -n 50
```

### Port already in use

```bash
# Find process using port 3000
lsof -i :3000

# Kill it if needed
kill -9 <PID>

# Or use a different port
nano backend/.env  # Change PORT=3000 to PORT=3001
```

## Security Checklist

- [ ] Change default API key (stored in config.json)
- [ ] Secure Discord bot token in bot/.env
- [ ] Enable UFW firewall
- [ ] Use HTTPS/SSL (Nginx reverse proxy recommended)
- [ ] Restrict SSH access (key-only authentication)
- [ ] Regular backups of configuration files
- [ ] Monitor logs for suspicious activity
- [ ] Keep system updated: `sudo apt update && sudo apt upgrade`

## Performance Tuning

### Increase Node.js Memory

Edit systemd services:
```bash
sudo nano /etc/systemd/system/mc-backend.service
```

Add to [Service] section:
```ini
Environment="NODE_OPTIONS=--max-old-space-size=2048"
```

```bash
sudo systemctl daemon-reload
sudo systemctl restart mc-backend.service
```

### Database Optimization

For future persistence layer, use indexes on frequently queried fields.

### Caching

Implement Redis for caching Modrinth API responses and reducing external API calls.

## Support

- GitHub Issues: https://github.com/Nithish1201-code/mc-official-bot/issues
- Minecraft Server: https://minecraft.net
- Discord.js Documentation: https://discord.js.org
